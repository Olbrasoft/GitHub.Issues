@page
@model Olbrasoft.GitHub.Issues.AspNetCore.RazorPages.Pages.IndexModel
@{
    ViewData["Title"] = "Hledat GitHub issues";
}

<!-- Database status notification area -->
<div id="dbStatusBanner" class="db-status-banner" style="display: none;">
    <div class="db-status-content">
        <span class="db-status-icon"></span>
        <span class="db-status-message"></span>
        <button id="dbActionBtn" class="db-action-btn" style="display: none;"></button>
        <button id="dbDismissBtn" class="db-dismiss-btn" title="Zavřít">&times;</button>
    </div>
</div>

<div class="search-container">
    <div class="search-header">
        <h1>Hledat GitHub issues</h1>
        <div class="header-actions">
            <!-- Auth controls - shown based on auth status -->
            <div id="authControls" class="auth-controls" style="display: none;">
                <span id="authUser" class="auth-user"></span>
                <a id="logoutLink" href="/logout" class="auth-link">Odhlásit</a>
            </div>
            <a id="loginLink" href="/login" class="auth-link login-link" style="display: none;">
                <span class="github-icon">&#xf09b;</span> Přihlásit přes GitHub
            </a>

            <!-- Sync button - only visible for authenticated owner -->
            <button id="syncBtn" class="sync-btn" title="Synchronizovat data z GitHubu" style="display: none;">
                <span class="sync-icon">&#8635;</span>
                <span class="sync-text">Importovat data</span>
            </button>
            <span id="dbStats" class="db-stats"></span>
        </div>
    </div>

    <form method="get" class="search-form" id="searchForm">
        <div class="search-row">
            <input type="text"
                   name="Query"
                   value="@Model.Query"
                   placeholder="Zadejte hledaný text..."
                   class="search-input" />
            <button type="submit" class="search-button">Hledat</button>
            <button type="button" class="reset-button" onclick="clearSearch()">Vymazat</button>
        </div>

        <div class="repo-filter-row">
            <label>Repozitáře:</label>
            <div class="tag-input-container" id="tagInputContainer">
                <div class="tags" id="selectedTags"></div>
                <input type="text"
                       id="repoSearchInput"
                       placeholder="Zadejte název repozitáře..."
                       autocomplete="off" />
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            <input type="hidden" name="Repos" id="reposHidden" value="@Model.Repos" />
        </div>

        <div class="filter-row">
            <label>Stav:</label>
            <select name="State" class="state-select">
                @if (Model.State == "all") { <option value="all" selected>Vše</option> } else { <option value="all">Vše</option> }
                @if (Model.State == "open") { <option value="open" selected>Otevřený</option> } else { <option value="open">Otevřený</option> }
                @if (Model.State == "closed") { <option value="closed" selected>Zavřený</option> } else { <option value="closed">Zavřený</option> }
            </select>

            <label>Jazyk shrnutí:</label>
            <select name="SummaryLanguage" class="language-select">
                @if (Model.SummaryLanguage == "en") { <option value="en" selected>English</option> } else { <option value="en">English</option> }
                @if (Model.SummaryLanguage == "cs") { <option value="cs" selected>Česky</option> } else { <option value="cs">Česky</option> }
                @if (Model.SummaryLanguage == "both") { <option value="both" selected>Obojí</option> } else { <option value="both">Obojí</option> }
            </select>

            <label>Položek na stránku:</label>
            <select name="PageSize" class="page-size-select" onchange="document.getElementById('searchForm').submit();">
                @foreach (var size in Model.PageSizeOptions)
                {
                    if (Model.PageSize == size)
                    {
                        <option value="@size" selected>@size</option>
                    }
                    else
                    {
                        <option value="@size">@size</option>
                    }
                }
            </select>
        </div>
        <input type="hidden" name="PageNum" value="1" />
    </form>
</div>

@if (Model.HasSearchCriteria)
{
    var currentUrl = $"/?Query={Uri.EscapeDataString(Model.Query ?? "")}&State={Model.State}&SummaryLanguage={Model.SummaryLanguage}&PageNum={Model.PageNumber}&PageSize={Model.PageSize}" +
                     (string.IsNullOrEmpty(Model.Repos) ? "" : $"&Repos={Model.Repos}");
    var returnUrlEncoded = Uri.EscapeDataString(currentUrl);

    <div class="results-container">
        <div class="results-header">
            <h2>Výsledky vyhledávání</h2>
            @if (Model.SearchResult.TotalCount > 0)
            {
                <span class="results-count">
                    Zobrazeno @((Model.PageNumber - 1) * Model.PageSize + 1)-@(Math.Min(Model.PageNumber * Model.PageSize, Model.SearchResult.TotalCount)) z @Model.SearchResult.TotalCount
                </span>
            }
        </div>

        @if (Model.SearchResult.Results.Count == 0)
        {
            <p class="no-results">Žádné výsledky</p>
        }
        else
        {
            <ul class="results-list">
                @foreach (var result in Model.SearchResult.Results)
                {
                    <li class="result-item" data-issue-id="@result.Id">
                        <div class="result-header">
                            <a href="/Issue/Detail/@result.Id?returnUrl=@returnUrlEncoded" class="result-title">#@result.IssueNumber @result.Title</a>
                            <span class="state-badge @(result.IsOpen ? "state-open" : "state-closed")">
                                @result.StateCzech
                            </span>
                            @foreach (var label in result.Labels)
                            {
                                <span class="label-badge" style="background-color: #@label.Color; color: @label.TextColor;">@label.Name</span>
                            }
                        </div>
                        <div class="ai-summary-container" data-issue-id="@result.Id">
                            @* Phase 1: Immediate body preview (shown right away) *@
                            <div class="body-preview">
                                @if (!string.IsNullOrEmpty(result.BodyPreview))
                                {
                                    @result.BodyPreview
                                }
                            </div>
                            @* Phase 2: AI Summary - initially hidden, SignalR populates and shows *@
                            <div class="ai-summary-en" style="display:none;"></div>
                            @* Phase 3: Translation - initially hidden, SignalR populates and shows *@
                            <div class="ai-summary-cs" style="display:none;"></div>
                        </div>
                        <div class="result-meta">
                            <span class="repository">@result.RepositoryName</span>
                            @if (result.IsExactMatch)
                            {
                                <span class="exact-match">Přesná shoda (#@result.IssueNumber)</span>
                            }
                            else
                            {
                                <span class="similarity">Podobnost: @result.SimilarityPercent</span>
                            }
                        </div>
                        <div class="result-actions">
                            <a href="/Issue/Detail/@result.Id?returnUrl=@returnUrlEncoded" class="detail-link">Zobrazit detail</a>
                            <a href="@result.Url" target="_blank" class="github-link">GitHub ↗</a>
                        </div>
                    </li>
                }
            </ul>

            @if (Model.SearchResult.TotalPages > 1)
            {
                <div class="pagination">
                    @if (Model.PageNumber > 1)
                    {
                        <a href="?Query=@Uri.EscapeDataString(Model.Query ?? "")&State=@Model.State&SummaryLanguage=@Model.SummaryLanguage&PageNum=@(Model.PageNumber - 1)&PageSize=@Model.PageSize@(string.IsNullOrEmpty(Model.Repos) ? "" : $"&Repos={Model.Repos}")" class="page-link">« Předchozí</a>
                    }

                    <span class="page-info">Stránka @Model.PageNumber z @Model.SearchResult.TotalPages</span>

                    @if (Model.PageNumber < Model.SearchResult.TotalPages)
                    {
                        <a href="?Query=@Uri.EscapeDataString(Model.Query ?? "")&State=@Model.State&SummaryLanguage=@Model.SummaryLanguage&PageNum=@(Model.PageNumber + 1)&PageSize=@Model.PageSize@(string.IsNullOrEmpty(Model.Repos) ? "" : $"&Repos={Model.Repos}")" class="page-link">Další »</a>
                    }
                </div>
            }
        }
    </div>
}

<!-- Sync Modal Dialog -->
<div id="syncModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2>Synchronizace dat</h2>
            <button id="modalCloseBtn" class="modal-close-btn" title="Zavřít">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-field">
                <label>Repozitáře:</label>
                <div class="tag-input-container" id="syncTagInputContainer">
                    <div class="tags" id="syncSelectedTags"></div>
                    <input type="text"
                           id="syncRepoSearchInput"
                           placeholder="Zadejte název repozitáře... (prázdné = všechny)"
                           autocomplete="off" />
                    <div class="autocomplete-dropdown" id="syncAutocompleteDropdown"></div>
                </div>
                <small class="field-hint">Prázdné pole = synchronizace všech repozitářů</small>
            </div>
            <div class="modal-field">
                <label class="checkbox-label">
                    <input type="checkbox" id="modalFullRefreshCheckbox" />
                    Plný refresh (stáhnout vše znovu, ignorovat timestamp)
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button id="modalCancelBtn" class="btn-secondary">Zrušit</button>
            <button id="modalSyncBtn" class="btn-primary">Synchronizovat</button>
        </div>
    </div>
</div>

<!-- Sync Result Modal -->
<div id="syncResultModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 id="syncResultTitle">Synchronizace dokončena</h2>
            <button id="resultCloseBtn" class="modal-close-btn" title="Zavřít">&times;</button>
        </div>
        <div class="modal-body">
            <div id="syncResultContent"></div>
        </div>
        <div class="modal-footer">
            <button id="resultOkBtn" class="btn-primary">Zavřít</button>
        </div>
    </div>
</div>

<!-- Hidden form for clearing search session -->
<form id="clearSearchForm" method="post" asp-page-handler="ClearSearch" style="display: none;"></form>

@section Scripts {
    <script>
        // Initialize selected repositories from server
        window.initialSelectedRepos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.SelectedRepositories.Select(r => new { id = r.Id, fullName = r.FullName })));

        // Clear search function - clears session and reloads page
        function clearSearch() {
            document.getElementById('clearSearchForm').submit();
        }
    </script>
    <script src="~/js/repo-filter.js"></script>
    <script src="~/js/db-status.js"></script>
    <script src="~/js/issue-updates.js"></script>
}
