@page
@model Olbrasoft.GitHub.Issues.AspNetCore.RazorPages.Pages.IndexModel
@{
    ViewData["Title"] = "Hledat GitHub issues";
}

<!-- Database status notification area -->
<div id="dbStatusBanner" class="db-status-banner" style="display: none;">
    <div class="db-status-content">
        <span class="db-status-icon"></span>
        <span class="db-status-message"></span>
        <button id="dbActionBtn" class="db-action-btn" style="display: none;"></button>
        <button id="dbDismissBtn" class="db-dismiss-btn" title="Zavřít">&times;</button>
    </div>
</div>

<div class="search-container">
    <div class="search-header">
        <h1>Hledat GitHub issues</h1>
        <div class="header-actions">
            <button id="importBtn" class="import-btn" title="Importovat data z GitHubu">
                <span class="import-icon">&#8635;</span>
                <span class="import-text">Importovat data</span>
            </button>
            <span id="dbStats" class="db-stats"></span>
        </div>
    </div>

    <form method="get" class="search-form" id="searchForm">
        <div class="search-row">
            <input type="text"
                   name="Query"
                   value="@Model.Query"
                   placeholder="Zadejte hledaný text..."
                   class="search-input" />
            <button type="submit" class="search-button">Hledat</button>
        </div>

        <div class="repo-filter-row">
            <label>Repozitáře:</label>
            <div class="tag-input-container" id="tagInputContainer">
                <div class="tags" id="selectedTags"></div>
                <input type="text"
                       id="repoSearchInput"
                       placeholder="Zadejte název repozitáře..."
                       autocomplete="off" />
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            <input type="hidden" name="Repos" id="reposHidden" value="@Model.Repos" />
        </div>

        <div class="filter-row">
            <label>Stav:</label>
            <select name="State" class="state-select">
                <option value="all" selected="@(Model.State == "all")">Vše</option>
                <option value="open" selected="@(Model.State == "open")">Otevřený</option>
                <option value="closed" selected="@(Model.State == "closed")">Zavřený</option>
            </select>

            <label>Položek na stránku:</label>
            <select name="PageSize" class="page-size-select" onchange="document.getElementById('searchForm').submit();">
                @foreach (var size in Model.PageSizeOptions)
                {
                    <option value="@size" selected="@(Model.PageSize == size)">@size</option>
                }
            </select>
        </div>
        <input type="hidden" name="PageNum" value="1" />
    </form>
</div>

@if (!string.IsNullOrWhiteSpace(Model.Query))
{
    <div class="results-container">
        <div class="results-header">
            <h2>Výsledky vyhledávání</h2>
            @if (Model.SearchResult.TotalCount > 0)
            {
                <span class="results-count">
                    Zobrazeno @((Model.PageNumber - 1) * Model.PageSize + 1)-@(Math.Min(Model.PageNumber * Model.PageSize, Model.SearchResult.TotalCount)) z @Model.SearchResult.TotalCount
                </span>
            }
        </div>

        @if (Model.SearchResult.Results.Count == 0)
        {
            <p class="no-results">Žádné výsledky</p>
        }
        else
        {
            <ul class="results-list">
                @foreach (var result in Model.SearchResult.Results)
                {
                    <li class="result-item">
                        <div class="result-header">
                            <a href="@result.Url" target="_blank" class="result-title">@result.Title</a>
                            <span class="state-badge @(result.IsOpen ? "state-open" : "state-closed")">
                                @result.StateCzech
                            </span>
                        </div>
                        @if (!string.IsNullOrEmpty(result.BodyPreview))
                        {
                            <div class="result-body-preview">
                                @result.BodyPreview
                            </div>
                        }
                        <div class="result-meta">
                            <span class="repository">@result.RepositoryName</span>
                            <span class="similarity">Podobnost: @result.SimilarityPercent</span>
                        </div>
                        <div class="result-actions">
                            <a href="/Issue/Detail/@result.Id" class="detail-link">Zobrazit detail</a>
                            <a href="@result.Url" target="_blank" class="github-link">GitHub ↗</a>
                        </div>
                    </li>
                }
            </ul>

            @if (Model.SearchResult.TotalPages > 1)
            {
                <div class="pagination">
                    @if (Model.PageNumber > 1)
                    {
                        <a href="?Query=@Uri.EscapeDataString(Model.Query ?? "")&State=@Model.State&PageNum=@(Model.PageNumber - 1)&PageSize=@Model.PageSize@(string.IsNullOrEmpty(Model.Repos) ? "" : $"&Repos={Model.Repos}")" class="page-link">« Předchozí</a>
                    }

                    <span class="page-info">Stránka @Model.PageNumber z @Model.SearchResult.TotalPages</span>

                    @if (Model.PageNumber < Model.SearchResult.TotalPages)
                    {
                        <a href="?Query=@Uri.EscapeDataString(Model.Query ?? "")&State=@Model.State&PageNum=@(Model.PageNumber + 1)&PageSize=@Model.PageSize@(string.IsNullOrEmpty(Model.Repos) ? "" : $"&Repos={Model.Repos}")" class="page-link">Další »</a>
                    }
                </div>
            }
        }
    </div>
}

@section Scripts {
    <script>
        // Initialize selected repositories from server
        window.initialSelectedRepos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.SelectedRepositories.Select(r => new { id = r.Id, fullName = r.FullName })));
    </script>
    <script src="~/js/repo-filter.js"></script>
    <script src="~/js/db-status.js"></script>
}
